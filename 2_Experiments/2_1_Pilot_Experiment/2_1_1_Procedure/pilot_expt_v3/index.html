<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Experiment</title>

  <script src="jspsych-7.0//plugins/jspsych.js"></script>
  <script src="jspsych-7.0//plugins/plugin-html-keyboard-response.js"></script>
  <!-- <script src="https://www.naodao.com/public/experiment/libs/plugin/plugin-categorize-html.js"></script> -->
  <!-- <script src="https://unpkg.com/@jspsych/plugin-virtual-chinrest@2.0.3"></script> -->
  <script src="jspsych-7.0//plugins/plugin-html-button-response.js"></script>
  <script src="jspsych-7.0//plugins/plugin-virtual-chinrest.js"></script>
  <script src="jspsych-7.0//plugins/plugin-survey-text.js"></script>
  <script src="jspsych-7.0//plugins/index_browser_rdk.js"></script>
  <script src="jspsych-7.0//plugins/plugin-preload.js"></script>
  <script src="jspsych-7.0//plugins/plugin-fullscreen.js"></script>
  <script src="jspsych-7.0//plugins/plugin-survey1.js"></script>
  <script src="jspsych-7.0//plugins/jspsych-staircase.js"></script>
  <!-- <script src="jspsych-7.0//plugins/staircase.js"></script> -->
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>

  <link rel='stylesheet' href="jspsych-7.0//css/jspsych.css">
  <link rel="stylesheet" href="jspsych-7.0//css/survey.css">
  <style>
    .jspsych-display-element {
      font-size: 22px;
    };

    .jspsych-content {
      max-width: 80%;
    };
  </style>
</head>

<body>

</body>

<script>


let userId;

// 使用 window.location.search 获取查询字符串
const queryString = window.location.search;
// 使用 new URLSearchParams 解析查询字符串
const urlParams = new URLSearchParams(queryString);
// 获取参数值
const testMode = urlParams.get('test')=="true"?true:false
userId = parseInt(urlParams.get('id'));
console.log("userId: ", userId)



var practOutput = [];
var formalOutput = [];
function sequence() {
  if (userId % 2 === 0) {
    var sequence = "color first";
  } else {
    var sequence = "motion first";
  }
  return sequence
};
var outPutAll = {
  task_sequence: sequence(),
  practice_task: practOutput,
  formal_task: formalOutput
};
var trialLength;
var reversalsNum;
var pract_cycle;
var formal_cycle;
var formal_stair_cycle_motion;
var formal_stair_cycle_color;
var rest_time;
var foraml_split_part_number;
//var formalTrialBlockMun;
var currentCycleMunMotion = 0;
var currentCycleMunColor = 0;

if (testMode) {
  trialLength = 4;
  reversalsNum = 2;
  pract_cycle = 1;
  formal_cycle = 1; //block 里面的循环
  //formalTrialBlockMun = 4;
  formal_stair_cycle_motion = 2; //condition 里面的循环
  formal_stair_cycle_color = 2;
  rest_time = 2000;
  foraml_split_part_number = 2;
} else {
  trialLength = 40;
  reversalsNum = 10;
  pract_cycle = 10; // 40个练习 trial
  formal_cycle = 5; //正式：一个 block 20 个 trial
  //formalTrialBlockMun = 20;
  formal_stair_cycle_motion = 10; // 正式循环 10 次
  formal_stair_cycle_color = 10;
  rest_time = 120000;
  foraml_split_part_number = 10
}


// -------------------- 初始化 --------------------

function saveJsonToFile(jsonData, filename) {
  // 将JSON对象转换为字符串
  const jsonString = JSON.stringify(jsonData);

  // 创建Blob对象，类型为application/json
  const blob = new Blob([jsonString], { type: "application/json" });

  // 创建一个链接元素用于下载
  const link = document.createElement("a");
  link.href = window.URL.createObjectURL(blob);
  link.download = filename.endsWith('.json') ? filename : `${filename}.json`;

  // 模拟点击下载
  document.body.appendChild(link);
  link.click();

  // 清理：移除链接并释放创建的URL对象
  document.body.removeChild(link);
  window.URL.revokeObjectURL(link.href);
}


var jsPsych = initJsPsych({
  /*on_start: function() {
    var urlvar = jsPsych.data.urlVariables();
    var testMode = urlvar.test=="true"?true:false
    userId = urlvar.id
  },*/
  on_finish: function() {
    //jsPsych.data.displayData();
    // 保存 outPut 为 json 文件
    saveJsonToFile(outPutAll, `pilot_expt_v3_${userId}.json`);
    jsPsych.data.get().localSave('csv', `pilot_expt_v3_${userId}.csv`);
    //jsPsych.data.addProperties(outPut)
    //jsPsych.data.get().filterColumns(['outPut']).localSave("json", `pilot_expt_v3_${userId}.json`);
  }
});

// 全屏模式
var fullScreen = {
  type: jsPsychFullscreen,
  fullscreen_mode: true,
  message: "<p>实验需要全屏模式，实验期间请勿退出全屏</P>",
  button_label: " <span class='add_' style='color:black; font-size: 20px'> 点击这里进入全屏</span>",
  data: {
    part: "fullScreen"
  },
};

//-------------------------收集被试信息----------------------

const subj_information = {
  type: jsPsychSurvey,
  survey_json: {
    showQuestionNumbers: true, title: "请填写基本信息", completeText: "提交",
    elements: [
      {
        type: "radiogroup",
        title: "性别",
        choices: ["男", "女"],
        isRequired: true,
        showNoneItem: false,
        showOtherItem: false,
        colCount: 0,
        name: "sex"
      },
      {
        type: 'text',
        title: "年龄",
        name: "age",
        isRequired: true,
        inputType: "number",
        min: 0,
        max: 100
      },
      {
        type: "radiogroup",
        title: "利手或惯用手",
        choices: ["左", "右"],
        isRequired: true,
        showNoneItem: false,
        showOtherItem: false,
        colCount: 0,
        name: "hands"
      },
      {
        type: "radiogroup",
        title: "是否为色盲或色弱",
        choices: ["色盲", "色弱", "都不是", "不确定"],
        isRequired: true,
        showNoneItem: false,
        showOtherItem: false,
        colCount: 0,
        name: "color_blindness"
      }
    ]
  },
  data: {
    part: "survey"
  },
  on_finish: function (data) {
    // window.subjectIdGlobal = data.response.subjectID;  //在这里获得被试id，把它存储为一个全局变量，用作之后的条件分配
  }
};

//------------------------- 任务所需要的指导语 --------------

// 练习阶段的指导语.
// 颜色条件
var intro_practice_color = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: left; color: white; padding: 10px"> 
      <h3 style="text-align: center; font-size: 30px; margin: 10px">颜色判断任务</h3> 
      <p>接下来，屏幕上会呈现一些运动的圆点，其中一半为 <span style="color: hsl(0, 50%, 50%)">红色</span> ，一半为 <span style="color: hsl(225, 50%, 50%)">蓝色</span>，</p>
        <p><span style="font-weight: bold">大约0.2秒后,</span>  一部分点会随机变为另一种颜色（例如从红色变为蓝色），变化后某种颜色的数量会超过另一种。</p >
        <p>您需要又快又准地判断判断 <span style="font-weight: bold">变化后，散点图的整体颜色（即大多数点的颜色）是红色还是蓝色 </span>：</p >
        <ul>
          <li>整体为 <span style="color: hsl(0, 50%, 50%)">红色</span>，请按键盘 <span style="color: hsl(0, 50%, 50%)">"D" 键</span></li>
          <li>整体为 <span style="color: hsl(225, 50%, 50%)">蓝色</span>，请按键盘 <span style="color: hsl(225, 50%, 50%)">"k" 键</span> </li>
        </ul>
        <p>请按下空格键进入练习阶段</p>
      </div>`,
  response_ends_trial: true,
  choices: " ",
  on_start: function () {
    document.body.style.backgroundColor = "black";
    document.body.style.cursor = 'none';
  },
  data: {
    part: "pract_color", 
  }
};
// 运动条件
var intro_practice_motion = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: left; color: white; padding: 10px"> 
      <h3 style="text-align: center; font-size: 30px; margin: 10px">运动方向判断任务</h3>
      <p>接下来，屏幕上会呈现一些运动的彩色圆点，</p>
      <p>大约 <span style="font-weight: bold">0.2秒</span> 后会有一定比例的点 <span style="font-weight: bold">一致地向左或向右运动</span> ，其余点随机运动</p >
      <p>您需要忽略点的颜色并又快又准地判断 <span style="font-weight: bold">一致的运动方向是向左还是向右</span>:</p >
      <ul>
        <li><span style="font-weight: bold">向左</span>，请按键盘 <span style="font-weight: bold">左键</span></li>
        <li><span style="font-weight: bold">向右</span>，请按键盘 <span style="font-weight: bold">右键</span> </li>
      </ul>
      <p>请按下空格键进入练习阶段</p>
    </div>`,
  response_ends_trial: true,
  choices: " ",
  on_start: function () {
    document.body.style.backgroundColor = "black";
    document.body.style.cursor = 'none';
  },
  data: {
    part: "pract_motion", 
  }
};
// 练习结束
var intro_practiceEnd = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: center; color: white; padding: 30px; font-size: 30px">
      <p>恭喜您完成练习，请按空格键进入正式任务。</p >
      <p> 正式任务只在每组测试结束后反馈</p>
    </div>
    `,
  response_ends_trial: true,
  choices: " ",
  /*on_finish: function () {
    document.body.style.backgroundColor = "black";
  },*/
  data: {
    part: "instruction_practiceEnd"
  },
};
// 正式阶段的指导语
// 颜色条件
var intro_formal_color = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: left; color: white; font-size: 30px; padding: 10px"> 
        <ul>
          <li>整体为 <span style="color: hsl(0, 50%, 50%)">红色</span>，请按键盘 <span style="color: hsl(0, 50%, 50%)">"D" 键</span></li>
          <li>整体为 <span style="color: hsl(225, 50%, 50%)">蓝色</span>，请按键盘 <span style="color: hsl(225, 50%, 50%)">"k" 键</span> </li>
        </ul>
        <p>请按下空格键进入正式阶段</p>
      </div>`,
  response_ends_trial: true,
  choices: " ",
  data: {
    part: "formal_color", 
  }
};
// 运动条件
var intro_formal_motion = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: left; color: white; font-size: 25px; padding: 10px"> 
      <ul>
        <li><span style="font-weight: bold">向左</span>，请按键盘 <span style="font-weight: bold">左键</span></li>
        <li><span style="font-weight: bold">向右</span>，请按键盘 <span style="font-weight: bold">右键</span> </li>
      </ul>
      <p>  请按下空格键进入正式阶段</p>
    </div>`,
  response_ends_trial: true,
  choices: " ",
  data: {
    part: "formal_motion", 
  }
};

// 休息阶段
var rest = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: center; color: white; padding: 35px; font-size: 35px">
      <p>请休息一下，若准备好可按空格键继续</p >
    </div>
    `,
  response_ends_trial: true,
  choices: " ",
  data: {
    part: "rest",
  }
};

// 阶段完成提示
var stepOneEnd = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: center; color: white; padding: 35px; font-size: 35px">
      <p>恭喜您已完成第一阶段的任务</p >
      <p>请休息两分钟，之后进入第二阶段</p >
    </div>
    `,
  trial_duration: rest_time,
  response_ends_trial: false,
  choices: " ",
  data: {
    part: "stepOneEnd",
  }
};

// 休息结束
var restEnd = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: center; color: white; padding: 35px; font-size: 35px">
      <p>休息结束，请按空格键继续</p >
    </div>
    `,
  response_ends_trial: true,
  choices: " ",
  data: {
    part: "restEnd",
  }
};

// 任务结束
var end = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align: center; color: white; padding: 20px; font-size: 35px">
      <p>您已完成实验，按下空格或 5 秒后自动退出全屏</p >
      <p>退出全屏后请允许下载多份文件，并等待文件下载</p >
    </div>
    `,
  trial_duration: 5000,
  fullscreen_mode: false,
  response_ends_trial: true,
  choices: " ",
  on_finish: function () {
    document.body.style.backgroundColor = "white";
    document.body.style.cursor = "auto"
  },
  data: {
    part: "end"
  },
};

//------------------------- 注视点 --------------

var fixation = { 
  type: jsPsychHtmlKeyboardResponse,
  stimulus: "<p style='font-size: 48px; color: white'>+</p >",
  trial_duration: 500,
  choices: "NO-KEYS",
  data: {
     part: "fixation"
  }
};

//-------------------------设置目标刺激出现的随机延迟时间-------------

function getRandomNumber(min, max) {
  return Math.random() * (max - min) + min;
}

/*
------------------------- 下面开始整个任务 -------------
------------------------- 习阶段设置为 n-down 1-up -----
------------------------- 正式阶段根据正确率调整难度 -----
*/

// -------------------------首先是练习阶段--------------------

var practBlockNumMotion = 0;
var practBlockNumColor = 0;
var parctTrialNumMotion = 0;
var parctTrialNumColor = 0;

// 设置调整参数
// Set starting proportion for practice to 1 (easiest)
var proportionColor= 0.6;
var proportionMotion = 0.24;
// This is the value that the coherence will decrease by after the fist reversal.
var proportionChange = 0.02;
// Set this value to the maximum number of trials before the experiment ends.
//var trialLength = 10;
// Set this value to the maximum number of reversals to occur before the trials end.
//var reversalsNum = 2;
// Set this value to the number of correct in a row before the staircase steps up (harder)
//var downStepHard = 2;
// Set this value to the number of correct in a row before the staircase steps up (easier)
//var downStepEasy = 4;
var downStep 


// These variables are for the staircase aspect. You shouldn't need to change anything here.
//var totalTrials = 0;
//var correctNum = 0;
//var reversals = 0;
var correct_choice;
var coherent_direction;
//var streak = 'correct';
var pract_final_proportion;

// 定义函数设置练习阶段不同难度的顺序(先易后难)
function currentDownStepMotion(easyFirst) {
  if (easyFirst) {
    if (practBlockNumMotion == 0) {
      downStep = 4;
    } else {
      downStep = 2;
    }
  }
  return downStep
};

function currentDownStepColor(easyFirst) {
  if (easyFirst) {
    if (practBlockNumColor == 0) {
      downStep = 4;
    } else {
      downStep = 2;
    }
    return downStep
  }
}

// 定义一个类来管理 trial 的状态
class TrialManager {
  // 初始化
  constructor() {
    this.totalTrialsColor = 0;
    this.streakColor = 'correct';
    this.reversalsColor = 0;
    this.correctNumColor = 0;
    
    this.totalTrialsMotion = 0;
    this.streakMotion = 'correct';
    this.reversalsMotion = 0;
    this.correctNumMotion = 0;
  };
  // 定义函数更新 trial 的状态 
  updateTrialStatus(lastAcc, isColorTrial) {
    // 判断当前试次是否为颜色判断 
    if (isColorTrial) {
      parctTrialNumColor += 1;
      this.totalTrialsColor += 1;
      // 处理颜色相关的更新逻辑
      if (lastAcc) { 
        this.correctNumColor += 1;
        if (this.correctNumColor == currentDownStepColor(true)) {
          proportionColor -= proportionChange;
          this.correctNumColor = 0;
        }
        // 检查颜色的反转等逻辑
        if (this.streakColor == 'incorrect') {
          this.reversalsColor += 1;
          this.streakColor = 'correct';
        }
      } else {
        this.correctNumColor = 0;
        proportionColor += proportionChange;
        if (this.streakColor == 'correct') {
          this.streakColor = 'incorrect';
          this.reversalsColor += 1;
        }
      }
      //设置 proportion 的上下阈限
      if (proportionColor > 0.8) {
          proportionColor = 0.8;
      } else if (proportionColor < 0.5) {
          proportionColor = 0.51;
      }
      // 输出相关信息，用于检查和调试
      console.log({
        "totalTrialsColor": parctTrialNumColor, 
        "currentDownStepColor": downStep,
        "proportionColor": proportionColor,
        "streakColor": this.streakMotion,
      })
    // 处理运动相关的更新逻辑，与颜色类似，只是对应的属性变成运动相关的
    } else { 
      parctTrialNumMotion += 1;
      this.totalTrialsMotion += 1;
      if (lastAcc) {
        this.correctNumMotion += 1;
        if (this.correctNumMotion == currentDownStepMotion(true)) {
          proportionMotion -= proportionChange;
          this.correctNumMotion = 0;
        }
        if (this.streakMotion == 'incorrect') {
          this.reversalsMotion += 1;
          this.streakMotion = 'correct';
        }
      } else {
        this.correctNumMotion = 0;
        proportionMotion += proportionChange;
        if (this.streakMotion == 'correct') {
          this.streakMotion = 'incorrect';
          this.reversalsMotion += 1;
        }
        //设置 proportion 的上下阈限
        if (proportionMotion > 0.26) {
          proportionMotion = 0.26;
        } else if (proportionMotion < 0.03) {
          proportionMotion = 0.03;
        }
      };
      // 输出信息
      console.log({
        "totalTrialsMotion": parctTrialNumMotion, 
        "currentDownStepMotion": downStep,
        "proportionMotion": proportionMotion,
        "streakMotion": this.streakMotion,
      })
    }
  }

  // 定义函数判断是否结束练习
  shouldEndTrial(isColorTrial) {
    if (isColorTrial) {
      // 判断颜色部分是否满足结束条件
      if (parctTrialNumColor >= trialLength) {
        return true;
      } else {
        return false;
      }
    } else {
      // 判断运动部分是否满足结束条件
      if (parctTrialNumMotion >= trialLength) {
        return true;
      } else {
        return false;
      }
    }
  }
}

// 使用 TrialManager 实例
var trialManager = new TrialManager();

// 定义练习阶段的单个 trial

// 颜色
var single_trial_color = {
  type: jsPsychRdk,
  target_color_proportion: function(){return proportionColor},
  correct_choice: jsPsych.timelineVariable("correct_choice"),
  dot_color: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"],
  color_change_delay: getRandomNumber(6, 12),
  dot_color_final: jsPsych.timelineVariable("dot_color_final"),
  move_distance: 3,
  coherence:0,
  //aperture_center_x: 400,
  //aperture_center_y: 300,
  aperture_width: 600,
  aperture_height: 600,
  number_of_dots: 100,
  choices: ["d", "k"], 
  background_color: 'black',
  dot_radius: 5.7,
  trial_duration: 3000,
  data: {
    part: "color_pract",
    task: "rdk",
    correct_responce: jsPsych.timelineVariable("correct_choice"),
    revs: function() { return this.reversalsColor},
    correctNum: function() { return this.correctNumColor},
    totalTrials: function() {return this.totalTrialsColor},
    proportionColor: function(){return proportionColor},
    proportionMotion: function(){return proportionMotion}, // 这里不要删，这是为了获取运动对应的 proportion 值 
  },
  on_start: function() {
    var displayElement = jsPsych.getDisplayElement();
    // 1000毫秒后隐藏刺激
    setTimeout(function() {
      var elements = displayElement.querySelectorAll("*");
      elements.forEach(function(el) {
        el.style.display = 'none';
      });
    }, 1000);
  },
  on_finish: function(data) {
    data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_responce);
    // 根据上个试次的反应更新下一个试次的 proportion 值
    var lastAcc = jsPsych.data.get().last(1).values()[0].correct;
    trialManager.updateTrialStatus(lastAcc, isColorTrial = true);
    // 重新显示元素
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    elements.forEach(function(el) {
      el.style.display = 'inline';
    });
  }
};

// 运动
var single_trial_motion = {
  type: jsPsychRdk,
  correct_choice: jsPsych.timelineVariable("correct_choice"),
  dot_color: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"],
  move_distance: 3,
  motion_change_delay: getRandomNumber(6, 12),
  coherent_direction: jsPsych.timelineVariable("coherent_direction"),
  coherence: function(){return proportionMotion},
  //aperture_center_x: 400,
  //aperture_center_y: 300,
  aperture_width: 600,
  aperture_height: 600,
  number_of_dots: 100,
  choices: ["ArrowLeft", "ArrowRight"], 
  background_color: 'black',
  dot_radius: 5.7,
  trial_duration: 3000,
  data: {
    part: "motion_pract",
    task: "rdk",
    correct_responce: jsPsych.timelineVariable("correct_choice"),
    revs: function() { return this.reversalsMotion},
    correctNum: function() { return this.correctNumMotion},
    totalTrials: function() {return this.totalTrialsMotion},
    proportionColor: function(){return proportionColor}, // 这里不要删，这是为了获取颜色对应的 proportion 值
    proportionMotion: function(){return proportionMotion}
  },
  on_start: function() {
    var displayElement = jsPsych.getDisplayElement();
    // 1000毫秒后隐藏刺激
    setTimeout(function() {
      var elements = displayElement.querySelectorAll("*");
      elements.forEach(function(el) {
        el.style.display = 'none';
      });
    }, 1000);
  },
  on_finish: function(data) {
    data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_responce);
    // 根据上个试次的反应更新下一个试次的 proportion 值
    var lastAcc = jsPsych.data.get().last(1).values()[0].correct;
    trialManager.updateTrialStatus(lastAcc, isColorTrial = false);
    // 重新显示元素
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    elements.forEach(function(el) {
      el.style.display = 'inline';
    });
  }
};

//练习阶段每个试次的反馈

var feedback_prect_tiral = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 500,
  stimulus: function () {
    // this function will check the accuracy of the last response and use that information to set
    // the stimulus value on each trial.
    var trial_data = jsPsych.data.get().last(1).values()[0];
    var correct = trial_data.correct;
    var rt = trial_data.rt
    if (rt > 0 && rt < 200) {
      return `<p style='font-size: 60px; color: yellow'>太快!</p>`;
    } else if (rt == -1) {
      return `<p style='font-size: 60px; color: yellow'>太慢!</p>`;
    } else if (correct) {
      return `<p style='font-size: 60px; color: green'>正确!</p>`;
    } else {
      return `<p style='font-size: 60px; color: red'>错误!</p>`;
    }
  },
};

//练习阶段每个 block 的反馈

var feedback_prect_block = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 2000,
  stimulus: function () {
    var trials = jsPsych.data.get().filter({ task: 'rdk' }).last(trialLength)
    var correct_trials = trials.filter({ correct: true });
    var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
    var rt = Math.round(trials.select('rt').mean());
    var rt_sd = Math.round(trials.select('rt').sd());
    // get final tiral of each practice block (获取传递给测试阶段的值)
    difficulty_motion = trials.last(1).values()[0].proportionMotion;
    difficulty_color = trials.last(1).values()[0].proportionColor;
    if (downStep == 2) {
      difficulty_motion_hard = difficulty_motion;
      //difficulty_motion_easy;
      difficulty_color_hard = difficulty_color;
      //difficulty_color_easy;
    } else if (downStep == 4) {
      difficulty_motion_easy = difficulty_motion;
      //difficulty_motion_hard
      difficulty_color_easy = difficulty_color;
      //difficulty_color_hard
    };
    outPut = { //将练习阶段的结果变成一个列表保存下来
      condition: {
        "difficulty_motion_hard": difficulty_motion_hard,
        "difficulty_motion_easy": difficulty_motion_easy,
        "difficulty_color_hard": difficulty_color_hard,
        "difficulty_color_easy": difficulty_color_easy
      },
      result: {
        "accuracy": accuracy,
        "rt": rt,
        "rt_sd": rt_sd
      }
    };
    practOutput.push(outPut);
    console.log(practOutput)
    /*console.log({"difficulty_motion_hard": difficulty_motion_hard, "difficulty_motion_easy": difficulty_motion_easy, 
      "difficulty_color_hard": difficulty_color_hard, "difficulty_color_easy": difficulty_color_easy});
    console.log({ accuracy: accuracy, rt: rt });*/
    return `<p style='font-size: 35px; color: white'>您的正确率为： ${accuracy}% 。平均反应时为：${rt}毫秒。</p>`; 
  },
};


// 定义练习的楼梯时间线 (trial)
var staircase_color = {
  timeline: [fixation, single_trial_color, feedback_prect_tiral],
  timeline_variables: [
    { dot_color_final: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"], correct_choice: "d" },
    { dot_color_final: ["hsl(225, 50%, 50%)", "hsl(0, 50%, 50%)"], correct_choice: "k" },
    { dot_color_final: ["hsl(225, 50%, 50%)", "hsl(0, 50%, 50%)"], correct_choice: "k" },
    { dot_color_final: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"], correct_choice: "d" }
  ],
  repetitions: pract_cycle,
  randomize_order: true
};

var staircase_motion = {
  timeline: [
    {
      timeline:[fixation, single_trial_motion, feedback_prect_tiral],
      timeline_variables: [
        { coherent_direction: 180, correct_choice: "ArrowLeft"},
        { coherent_direction: 0, correct_choice: "ArrowRight" },
        { coherent_direction: 0, correct_choice: "ArrowRight" },
        { coherent_direction: 180, correct_choice: "ArrowLeft" }
      ],
      repetitions: pract_cycle,
      randomize_order: true
    }
  ]
}
// 定义练习的循环时间线 (是否结束此 block)
var loop_node_color = {
  timeline: [staircase_color],
  loop_function: function(data){
    if(!trialManager.shouldEndTrial(true)){
      return true;
    } else {
      pract_finished = true;
      return false;
    }
  }
};

var loop_node_motion = {
  timeline: [staircase_motion],
  loop_function: function(data){
    if(!trialManager.shouldEndTrial(false)){
      return true;
    } else {
      pract_finished = true;
      return false;
    }
  }
};


// 定义练习的 block 时间线 （执行两个不同难度的 block）
var loop_block_color = {
  timeline: [loop_node_color, feedback_prect_block],
  loop_function: function(){
    if(practBlockNumColor == 0 ){
      practBlockNumColor += 1;
      parctTrialNumColor = 0;
      return true;
    } else {
      return false;
    }
  }
};

var loop_block_motion = {
  timeline: [loop_node_motion, feedback_prect_block],
  loop_function: function(){
    if(practBlockNumMotion == 0 ){
      practBlockNumMotion += 1;
      parctTrialNumMotion = 0;
      return true;
    } else {
      return false;
    }
    console.log("difficulty_practFinal_motion:" + difficulty_motion);
  }
};


/* 完成练习后，获取最终的 proportion 值，并作为正式阶段 proportion 的初始值， 
这里命名为 difficulty */

//---------------------------------下面是正式测试阶段----------------------

var formalPartMotion = 0;
var formalPartColor = 0;
var currentDifficulty
var difficulty_motion
var difficulty_motion_hard
var difficulty_motion_easy
var difficulty_color
var difficulty_color_hard
var difficulty_color_easy


// 获取初始难度值（然后传递给单个试次），并规定难度范围
const easyStaircaseColor = {
  // 这里的 max 和 min 是指难度的最大值和最小值，对应的是信号水平，颜色的难度范围为 0.66 - 0.51 = 0.15
  max: 0.51,
  min: 0.66,
  get: () => {
    console.log("difficulty_formal_color_easy:" + difficulty_color_easy);
    return difficulty_color_easy;
  },
  set: (value) => {
    difficulty_color_easy = value;
  },
};

const hardStaircaseColor = {
  // 这里的 max 和 min 是指难度的最大值和最小值，对应的是信号水平，颜色的难度范围为 0.66 - 0.51 = 0.15
  max: 0.51,
  min: 0.66,
  get: () => {
    console.log("difficulty_formal_color_hard:" + difficulty_color_hard);
    return difficulty_color_hard;
  },
  set: (value) => {
    difficulty_color_hard = value;
  },
};


const easyStaircaseMotion = {
  // 这里的 max 和 min 是指难度的最大值和最小值，运动的难度范围为 0.20 - 0.02 = 0.18
  max: 0.02,
  min: 0.20,
  get: () => {
    console.log("difficulty_formal_motion_easy:" + difficulty_motion_easy);
    return difficulty_motion_easy;
  },
  set: (value) => {
    difficulty_motion_easy = value;
  },
};

const hardStaircaseMotion = {
  // 这里的 max 和 min 是指难度的最大值和最小值，运动的难度范围为 0.20 - 0.02 = 0.18
  max: 0.02,
  min: 0.20,
  get: () => {
    console.log("difficulty_formal_motion_hard:" + difficulty_motion_hard);
    return difficulty_motion_hard
  },
  set: (value) => {
    difficulty_motion_hard = value;
  },
};

// 定义函数来获取并传递对应的难度水平（传给单个 trial）
function setCurrentDifficultyMotion(formalPartMotion) {
  var difficultyArrayMotion = [easyStaircaseMotion.get(), hardStaircaseMotion.get()];
  if (formalPartMotion == 0) {
      currentDifficulty = difficultyArrayMotion[0];
  } else {
      currentDifficulty = difficultyArrayMotion[1];
  }
  console.log("currentDifficultyMotion:" + currentDifficulty);
  return currentDifficulty;
};

function setCurrentDifficultyColor(formalPartColor) {
  var difficultyArrayColor = [easyStaircaseColor.get(), hardStaircaseColor.get()];
  if (formalPartColor == 0) {
      currentDifficulty = difficultyArrayColor[0];
  } else {
      currentDifficulty = difficultyArrayColor[1];
  }
  console.log("currentDifficultyColor:" + currentDifficulty);
  return currentDifficulty;
}

// 正式阶段的单个 trial
var formal_single_trial_color = {
  type: jsPsychRdk,
  post_trial_gap: 500,
  number_of_dots: 100,
  RDK_type: 3,
  dot_color: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"],
  color_change_delay: getRandomNumber(6, 12),
  dot_color_final: jsPsych.timelineVariable("dot_color_final"),
  target_color_proportion: function() { return setCurrentDifficultyColor(formalPartColor)},
  choices: ["d", "k"],
  correct_choice: jsPsych.timelineVariable("correct_choice"),
  dot_radius: 5.7,
  move_distance: 3,
  coherence: 0,
  aperture_width: 600,
  aperture_height: 600,
  //aperture_center_y: 300,
  //aperture_center_x: 400, 
  background_color: "black",
  trial_duration: 3000,
  data: {
    part: "color_formal",
    correct_responce: jsPsych.timelineVariable("correct_choice") ,
    data_label: 'staircase_color',
  },
  on_start: function() {
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    // 1000毫秒后隐藏刺激
    setTimeout(function() {
      //var elements = displayElement.querySelectorAll("*");
      elements.forEach(function(el) {
        el.style.display = 'none';
      });
    }, 1000);
  },
  on_finish: function(data){
    data.data_label = 'staircase_color';
    data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_responce);
    // 重新显示元素
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    elements.forEach(function(el) {
      el.style.display = 'inline';
    });
  }
};

var formal_single_trial_motion = {
  type: jsPsychRdk,
  post_trial_gap: 500,
  number_of_dots: 100,
  RDK_type: 3,
  dot_color: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"],
  motion_change_delay: function() {return getRandomNumber(6, 12)},
  coherent_direction: jsPsych.timelineVariable("coherent_direction"),
  coherence: function() {return setCurrentDifficultyMotion(formalPartMotion)},
  choices: ["ArrowLeft", "ArrowRight"],
  correct_choice: jsPsych.timelineVariable("correct_choice"),
  dot_radius: 5.7,
  move_distance: 3,
  aperture_width: 600,
  aperture_height: 600,
  //aperture_center_y: 300,
  //aperture_center_x: 400, 
  background_color: "black",
  trial_duration: 3000,
  data: {
    part: "motion_formal",
    correct_responce: jsPsych.timelineVariable("correct_choice") ,
    data_label: 'staircase_motion'
  },
  on_start: function() {
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    // 1000毫秒后隐藏刺激
    setTimeout(function() {
      //var elements = displayElement.querySelectorAll("*");
      elements.forEach(function(el) {
        el.style.display = 'none';
      });
    }, 1000);
  },
  on_finish: function(data){
    data.data_label = 'staircase_motion';
    data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_responce);
    // 重新显示元素
    var displayElement = jsPsych.getDisplayElement();
    var elements = displayElement.querySelectorAll("*");
    elements.forEach(function(el) {
      el.style.display = 'inline';
    });
  }
};

var feedback_formal_block_motion = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 2000,
  stimulus: function () {
    var trials = jsPsych.data.get().filter({data_label:'staircase_motion'}).last(20); // 这里必须要写成数字才能变化难度，好奇怪
    var task = trials.select("part").values[0];
    var correct_trials = trials.filter({correct: true });
    var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
    var rt = Math.round(trials.select('rt').mean());
    var rt_sd = Math.round(trials.select('rt').sd());
    var coherence = trials.select('coherence').mean();
    // 创建一个包含条件和结果的对象
    outPut = {
      condition: {
        "firstTask": task,
        "motionCoherence": coherence,
      },
      result: {
        "accuracy": accuracy,
        "rt": rt,
        "rt_sd": rt_sd
      }
    };
    formalOutput.push(outPut);
    console.log(formalOutput)
    //console.log({ accuracy: accuracy, rt: rt });
    return `<p style='font-size: 35px; color: white'>您的正确率为： ${accuracy}% 。平均反应时为：${rt}毫秒。</p>`; 
  },
};

var feedback_formal_block_color = {
  type: jsPsychHtmlKeyboardResponse,
  trial_duration: 2000,
  stimulus: function () {
    var trials = jsPsych.data.get().filter({data_label:'staircase_color'}).last(20);
    var task = trials.select("part").values[0];
    var correct_trials = trials.filter({correct: true });
    var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
    var rt = Math.round(trials.select('rt').mean());
    var rt_sd = Math.round(trials.select('rt').sd());
    var proportion = trials.select('target_color_proportion').mean()
    // 创建一个包含条件和结果的对象
    outPut = {
      condition: {
        "task": task,
        "colorProportion": proportion
      },
      result: {
        "accuracy": accuracy,
        "rt": rt,
        "rt_sd": rt_sd
      }
    };
    formalOutput.push(outPut);
    console.log(formalOutput)
    //console.log({ accuracy: accuracy, rt: rt });
    return `<p style='font-size: 35px; color: white'>您的正确率为： ${accuracy}% 。平均反应时为：${rt}毫秒。</p>`; 
  },
};

//设置正式阶段任务的循环的时间线
var cycle_rdk_color = {
  timeline: [fixation, formal_single_trial_color],
  timeline_variables: [
    { dot_color_final: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"], correct_choice: "d" },
    { dot_color_final: ["hsl(225, 50%, 50%)", "hsl(0, 50%, 50%)"], correct_choice: "k" },
    { dot_color_final: ["hsl(225, 50%, 50%)", "hsl(0, 50%, 50%)"], correct_choice: "k" },
    { dot_color_final: ["hsl(0, 50%, 50%)", "hsl(225, 50%, 50%)"], correct_choice: "d" }
  ],
  repetitions: formal_cycle,
  randomize_order: true
};

var cycle_rdk_motion = {
  timeline: [fixation, formal_single_trial_motion],
  timeline_variables: [
    { coherent_direction: 180, correct_choice: "ArrowLeft"},
    { coherent_direction: 0, correct_choice: "ArrowRight" },
    { coherent_direction: 0, correct_choice: "ArrowRight" },
    { coherent_direction: 180, correct_choice: "ArrowLeft" }
  ],
  repetitions: formal_cycle,
  randomize_order: true
};

// 加上 block 反馈的时间线
var cycle_color = {
  timeline: [cycle_rdk_color, feedback_formal_block_color],
  on_timeline_finish: function() {
    //var block_data = jsPsych.data.get();
    currentCycleMunColor += 1
  }
};

var cycle_motion = {
  timeline: [cycle_rdk_motion, feedback_formal_block_motion],
  on_timeline_finish: function() {
    //var block_data = jsPsych.data.get();
    currentCycleMunMotion += 1
  }
};


// generateStaircaseTimeline 为外部调用的函数，用于生成测试（正式任务）阶段的 staircase
var formal_color_easy = generateStaircaseTimeline({
  // Your jsPsych instance (required to fetch data)
  jsPsychInstance: jsPsych,
  // The target accurcy (between 0 and 1)
  targetAccuracy: 0.80,
  // The number of cycles to be carried out
  numberOfCycles: formal_stair_cycle_color,
  // The difficulty object
  difficulty: easyStaircaseColor,
  // The data label. Must be the same string that you added to the response
  // trials.
  dataLabel: 'staircase_color',
  // And finally your cycle.
  cycle: cycle_color,
});

var formal_color_hard = generateStaircaseTimeline({
  jsPsychInstance: jsPsych,
  targetAccuracy: 0.60,
  numberOfCycles: formal_stair_cycle_color,
  difficulty: hardStaircaseColor,
  dataLabel: 'staircase_color',
  cycle: cycle_color,
});

var formal_motion_easy = generateStaircaseTimeline({
  jsPsychInstance: jsPsych,
  targetAccuracy: 0.80,
  numberOfCycles: formal_stair_cycle_motion,
  difficulty: easyStaircaseMotion,
  dataLabel: 'staircase_motion',
  cycle: cycle_motion,
});

var formal_motion_hard = generateStaircaseTimeline({
  jsPsychInstance: jsPsych,
  targetAccuracy: 0.60,
  numberOfCycles: formal_stair_cycle_motion,
  difficulty: hardStaircaseMotion,
  dataLabel: 'staircase_motion',
  cycle: cycle_motion,
});

var formal_block_motion_easy = {
  timeline: [formal_motion_easy, stepOneEnd, restEnd],
  on_timeline_finish: function() {
    if(currentCycleMunMotion >= foraml_split_part_number ){
      formalPartMotion = 1;
    } else {
      formalPartMotion = 0
    }
    console.log('current condition number ', formalPartMotion)
  }
};

var formal_block_motion = {
  timeline: [formal_block_motion_easy, formal_motion_hard]
};

var formal_block_color_easy = {
  timeline: [formal_color_easy, stepOneEnd, restEnd],
  on_timeline_finish: function() {
    if(currentCycleMunColor >= foraml_split_part_number ){
      formalPartColor = 1;
    } else {
      formalPartColor = 0
    }
    console.log('current condition number ', formalPartColor)
  }
};

var formal_block_color = {
  timeline: [formal_block_color_easy, formal_color_hard]
}

/*---------------------------------------------------------------------
将不同的条件组合，根据被试编号分配，奇数被试先运动后颜色，偶数被试先颜色后运动
-----------------------------------------------------------------------*/

// 颜色条件
var color_total = {
  timeline: [intro_practice_color, loop_block_color, intro_practiceEnd, intro_formal_color, formal_block_color] 
};
//运动条件
var motion_total = {
  timeline: [intro_practice_motion, loop_block_motion, intro_practiceEnd, intro_formal_motion, formal_block_motion]
}

// 根据 id 进行分配
var color_first = {
  timeline: [color_total, motion_total],
  conditional_function: function(){
    if (userId % 2 === 0) {
      sequence = "color first";
      console.log(sequence);
      return true;
    } else {
      return false;
    }
  }
};
//运动条件
var motion_first = {
  timeline: [motion_total, color_total],
  conditional_function: function(){
    if (userId % 2 !== 0) {
      sequence = "motion first";
      console.log(sequence);
      return true;
    } else {
      return false;
    }
  }
};


//---------- 整个任务的时间线 ----------

var timeline = {
  timeline: [fullScreen, subj_information, color_first, motion_first, end]
}

// 运行实验
jsPsych.run([timeline])



</script>