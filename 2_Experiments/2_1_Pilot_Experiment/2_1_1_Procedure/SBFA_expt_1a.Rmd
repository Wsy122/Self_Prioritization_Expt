---
title: "采用贝叶斯序列分析确定样本量"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
documentclass: ctexart
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

**markdown的内容：数据预处理 + BF 值计算**

-   数据预处理
    -   剔除极端值
    -   分组计算 RT, ACC, d prime
    -   将得到的数据以新的 csv 文件输出
-   BF 值计算

------------------------------------------------------------------------

-   研究中的关键效应

| 研究问题                                       | 统计假设                                                                                           | 因变量                              | 可能的 BF 值（加粗为关键）                                                         |
|-----------------|-----------------|-----------------|-----------------------|
| 自我关联是否对知觉判断中不同难度的试次产生影响 | 知觉难度与自我相关性的交互作用<br>知觉难度与自我相关性的交互作用<br>知觉难度与自我相关性的交互作用 | **RT**<br>ACC<br> ***d*** **prime** | **2×4 RM ANOVA 中的交互作用**<br>2×4 RM ANOVA 中的交互作用<br>**One way RM ANOVA** |

-   停止规则：
    -   贝叶斯因子阈值确定为10
    -   最小样本量40，最大样本量70

```{r}
rm(list = ls())
```

下载和安装需要的R语言程序包

```{r message=FALSE, warning=FALSE}
# install.packages(c("tidyverse", "BayesFactor", "here"))
library(BayesFactor)#计算t检验和方差分析的贝叶斯因子
library(tidyverse)
library(showtext)#解决中文字体无法显示问题
library(latex2exp)#latex语法
# font_add("song", 
         # "/System/Library/Fonts/Supplemental/Songti.ttc")
##从系统增加宋体字
showtext_auto()
library(here)
here()
options(scipen = 9)#将科学计数法改为在万后9位
set.seed(1234)
```

BayesFacotr包版本

```{r}
packageVersion("BayesFactor")
```

# 数据预处理

## 读取目录下的原始数据

```{r}
# 文件路径和文件名根据实际情况调整
# 设置目标文件夹相对路径
folder_path <- "../2_1_2_RawData/pilot_expt_v4.3"

# 列出所有含有"pilot_expt_v4_"的csv文件
file_list <- list.files(
  path = folder_path,
  pattern = "*pilot_expt_v4-2_.*\\.csv$", full.names = TRUE
)

# 创建一个空列表来存储数据
df_list_1 <- list()

# 逐个读取文件并存储
for (file in file_list) {
  file_name <- tools::file_path_sans_ext(basename(file))  # 获取文件名（不带扩展名）
  df_list_1[[file_name]] <- read.csv(file)  # 将数据存储在列表中
}
#rm(file, file_list, folder_path)
```

## 数据清洗

```{r}
# 创建输出文件夹（如果不存在）
output_path <- "../2_1_3_CleanData/pilot_expt_v4.3"
if (!dir.exists(output_path)) {
  dir.create(output_path, recursive = TRUE)
}

# 逐篇处理每个数据框
for (file_name in names(df_list_1)) {
  data <- df_list_1[[file_name]]

  # 提取被试信息
  participant_info <- data[data$part == "survey", "response"]
  participant_info <- gsub("[{}\"]", "", participant_info) # 去掉多余的字符
  info_list <- strsplit(participant_info, ",")[[1]]

  # 创建新的变量
  participant_data <- data.frame(
    subj_idx = file_name,
    Sex = as.character(NA),
    Age = as.numeric(NA),
    Handedness = as.character(NA),
    Color_blindness = as.character(NA),
    stringsAsFactors = FALSE
  )
  
  # 先按照下划线分割字符串
  split_data <- strsplit(participant_data$subj_idx, "_")
  # 提取分割后的第四个元素（数字部分在第四个位置，可根据实际调整）并转换为数值
  participant_data$subj_idx <- as.numeric(lapply(split_data, function(x) substr(x[[4]], 1, 2)))

  for (info in info_list) {
    key_value <- strsplit(info, ":")[[1]]
    key <- trimws(key_value[1])
    value <- trimws(key_value[2])
    if (key == "sex") participant_data$Sex <- value
    if (key == "age") participant_data$Age <- as.numeric(value)
    if (key == "hands") participant_data$Handedness <- value
    if (key == "color_blindness") participant_data$Color_blindness <- value
  }

  # 提取行为数据
  behavior_data <- data[
    data$part %in% c("motion_test","match_RDK","RDK"),
    c(
      "part", "rt", "response", "correct", "coherent_direction","coherence",
      "isMatch", "association", "difficulty", "dot_color_final","target_color_proportion"
    )
  ]
  
  # 分别提取正式试次
  official_trials <- do.call(
    rbind,
    lapply(unique(behavior_data$part), function(part) {
      part_data <- behavior_data[behavior_data$part == part, ]
      if (part == "match_RDK") {
        return(tail(part_data, 384)) # 匹配任务384次
      } else if (part == "RDK") {
        return(tail(part_data, 192)) # 辨别任务192次
      } else {
        return(NULL)
      }
    })
  )

  # 合并被试信息和行为数据
  final_data <- cbind(participant_data, official_trials)

  # 输出到新的CSV文件
  output_file <- file.path(output_path, paste0(file_name, "_Clean.csv"))
  write.csv(final_data, output_file, row.names = FALSE)
}
```

## 读取清洗后的数据

```{r message=FALSE}
# 设置目标文件夹相对路径
folder_path <- "../2_1_3_CleanData/pilot_expt_v4.3"

# 列出所有含有"pilot_expt_"的csv文件
file_list <- list.files(
  path = folder_path,
  pattern = "*pilot_expt_v4-2_.*\\.csv$", full.names = TRUE
)

# 创建一个空列表来存储数据
df_list_1 <- list()

# 逐个读取文件并存储
for (file in file_list) {
  file_name <- tools::file_path_sans_ext(basename(file)) # 获取文件名（不带扩展名）
  df_list_1[[file_name]] <- read.csv(file) # 将数据存储在列表中
}

# 清除不需要的变量
rm(output_path, participant_info, info_list, participant_data, split_data,
   behavior_data, official_trials, final_data, output_file, file, file_list,
   file_name, folder_path, info, key, key_value, value)

# 把 df_list_1 传送给 data
data <- do.call(rbind, df_list_1)
```

## 分组计算RT, ACC, d prime

定义函数，用来计算平均反应时和正确率

```{r}
copmute_rt_acc <- function(data){
  data <- data %>%
  filter(part %in% c("match_RDK","RDK")) %>%
    group_by(subj_idx, part, difficulty, association) %>%  #按被试与难度和关联类型分组
    summarise(
      rt = mean(rt, na.rm = TRUE),#每个被试所有trial的平均反应时
      rt_max = max(rt, na.rm = TRUE),#每个被试所有trial的最大反应时
      rt_min = min(rt, na.rm = TRUE),#每个被试所有trial的最小反应时
      sd_rt = sd(rt, na.rm = TRUE), #每个被试所有trial的反应时的方差
      all_count = n(),#每个被试在每个条件的总trial数量
      row_count = sum(rt >= 200 & rt <= 3000, na.rm = TRUE), #舍弃按键太快和按键太慢的反应时
      correct_count = sum(correct == 'true' & rt >= 200 & rt <= 3000, na.rm = TRUE),
      acc = correct_count /all_count, #计算每个被试在每个条件的正确率= 正确/总数
      .groups = "drop")
   
    # 返回处理后的数据
    return(data)
}
```

定义函数，分别计算运动组和颜色组的 d prime

```{r}
# 运动组
compute_std_rdk_motion <- function(data) {
  sdt_rdk_motion <- data %>% #选择正式实验的数据
    filter(part == "RDK") %>%
    # filter(subj_idx %% 2 == 0) %>% # 被试id为偶数，左运动代表自己
    group_by(subj_idx, difficulty) %>%  #按被试与条件分组
    dplyr::mutate(
      # 统一以左为信号右为噪声
      type = dplyr::case_when(
        (response == "arrowleft" & coherent_direction == 180) ~ "hit",
        (response == "arrowright" & coherent_direction == 0) ~ "cr",
        (response == "arrowright" & coherent_direction == 180) ~ "miss",
        (response == "arrowleft" & coherent_direction == 0) ~ "fa",
        )) %>%
    summarize(
      hit = sum(type == "hit"),
      miss = sum(type == "miss"),
      fa = sum(type == "fa"),
      cr = sum(type == "cr"),
      .groups = "drop")
  
  # 计算 dprime 和 crit
  sdt_rdk_motion <- sdt_rdk_motion %>%
    dplyr::mutate(hitR = hit/(hit + miss),  # hit rate
                  faR  = fa/(fa+cr)) %>%    # fa rate
    replace_na(list(hitR = 0, faR = 0)) %>%
    # if hit rate is 1, standardize it
    dplyr::mutate(hitR = ifelse(hitR == 1, 1 - 1/(2*(hit + miss)), hitR), 
                  # if FA rate is 0, standardize it
                  faR  = ifelse(faR == 0, 1/(2*(hit + miss)), faR)) %>% 
    dplyr::mutate(dprime = qnorm(hitR) - qnorm(faR),
                  zfa = qnorm(fa / (fa+cr)),
                  crit = -zfa
    ) %>%
    dplyr::mutate( dprime = round(dprime, 2),
            crit = round(crit, 2)
    )
  return(sdt_rdk_motion)
}
```

```{r}
compute_std_rdk_color <- function(data) {
  sdt_rdk_color <- data %>%
    dplyr::mutate(
    dot_color_final = dplyr::case_when(
      dot_color_final == '["hsl(0, 50%, 50%)","hsl(225, 50%, 50%)"]' ~ "r",
      dot_color_final == '["hsl(225, 50%, 50%)","hsl(0, 50%, 50%)"]' ~ "b"))
  sdt_rdk_color <- sdt_rdk_color %>% #选择正式实验的数据
    filter(part == "RDK") %>%
    # filter(subj_id %% 2 == 0) %>% # 被试id为偶数，red代表自己
    group_by(subj_idx, difficulty) %>%  #按被试与条件分组
    dplyr::mutate(
      # 红为信号，蓝为噪声
      type = dplyr::case_when(
        (response == "d" & dot_color_final == "r") ~ "hit",
        (response == "k" & dot_color_final == "b") ~ "cr",
        (response == "k" & dot_color_final == "r") ~ "miss",
        (response == "d" & dot_color_final == "b") ~ "fa")) %>%
    summarize(
      hit = sum(type == "hit"),
      miss = sum(type == "miss"),
      fa = sum(type == "fa"),
      cr = sum(type == "cr"),
      .groups = "drop")
  
  sdt_rdk_color <- sdt_rdk_color %>%
    dplyr::mutate(hitR = hit/(hit + miss),  # hit rate
                  faR  = fa/(fa+cr)) %>%    # fa rate
    replace_na(list(hitR = 0, faR = 0)) %>%
    # if hit rate is 1, standardize it
    dplyr::mutate(hitR = ifelse(hitR == 1, 1 - 1/(2*(hit + miss)), hitR), 
                  # if FA rate is 0, standardize it
                  faR  = ifelse(faR == 0, 1/(2*(hit + miss)), faR)) %>% 
    dplyr::mutate(dprime = qnorm(hitR) - qnorm(faR),
                  zfa = qnorm(fa / (fa+cr)),
                  crit = -zfa
    ) %>%
    mutate( dprime = round(dprime, 2),
            crit = round(crit, 2)
    )
  
  return(sdt_rdk_color)
}
```

```{r}
data <- data %>%
  #筛出反应时在200~3000)
  filter(rt >= 200 & rt <= 3000)

# Motion
data1 <- data %>%
  filter(
    subj_idx %in% c( seq(1, 10))) # 被试编号 1-10 为运动组

data_motion_rt_acc <- copmute_rt_acc(data1) %>%
  dplyr::mutate(group = "motion")

data_motion_dprime <- compute_std_rdk_motion(data1) %>%
  dplyr::mutate(group = "motion")

# Color
data2 <- data %>%
  filter(
    subj_idx %in% c( seq(11, 20))) # 被试编号 11-20 为颜色组

data_color_rt_acc <- copmute_rt_acc(data2) %>%
  dplyr::mutate(group = "color")

data_color_dprime <- compute_std_rdk_color(data2) %>%
  dplyr::mutate(group = "color")
```

## 数据整理(需要长数据)

### 因变量为RT的数据整理

运动组

```{r}
#分析因变量为RT的使用数据
df_rt_motion <- data_motion_rt_acc %>%
  #选择被试信息以及RT_开头的列
  dplyr::select(subj_idx, rt, association, difficulty, group) %>%
  # 添加新列 dv_name，值为 RT
  dplyr::mutate(dv_name = "RT") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         association = as.factor(association),
         difficulty = as.factor(difficulty))

head(df_rt_motion)
```

颜色组

```{r}
#分析因变量为RT的使用数据
df_rt_color <- data_color_rt_acc %>%
  #选择被试信息以及RT_开头的列
  dplyr::select(subj_idx, rt, association, difficulty, group) %>%
  # 添加新列 dv_name，值为 RT
  dplyr::mutate(dv_name = "RT") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         association = as.factor(association),
         difficulty = as.factor(difficulty))

head(df_rt_color)
```

### 因变量为ACC的数据整理

运动组

```{r}
df_acc_motion <- data_motion_rt_acc %>% 
  dplyr::select(subj_idx, acc, association, difficulty, group) %>%
  # 添加新列 dv_name，值为 ACC
  dplyr::mutate(dv_name = "ACC") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         association = as.factor(association),
         difficulty = as.factor(difficulty))

head(df_acc_motion)
```

颜色组

```{r}
df_acc_color <- data_color_rt_acc %>% 
  dplyr::select(subj_idx, acc, association, difficulty, group) %>%
  # 添加新列 dv_name，值为 ACC
  dplyr::mutate(dv_name = "ACC") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         association = as.factor(association),
         difficulty = as.factor(difficulty))

head(df_acc_color)
```

### 因变量为dPrime的数据整理

运动组

```{r}
df_dPrime_motion <- data_motion_dprime %>% 
  dplyr::select(subj_idx, dprime, difficulty, group) %>%
  # 添加新列 dv_name，值为 dPrime
  dplyr::mutate(dv_name = "dPrime") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         difficulty = as.factor(difficulty))

head(df_dPrime_motion)
```

颜色组

```{r}
df_dPrime_color <- data_color_dprime %>% 
  dplyr::select(subj_idx, dprime, difficulty, group) %>%
  # 添加新列 dv_name，值为 dPrime
  dplyr::mutate(dv_name = "dPrime") %>%
  #类型为character的转换为因子类型，便于后续分析
  mutate(subj_idx = as.factor(subj_idx),
         difficulty = as.factor(difficulty))

head(df_dPrime_color)
```

# BF 值计算

## 定义函数,用来计算 BF 值与绘图

```{r}
# 计算 acc 的 bf 值
analyze_acc_bf <- function(input_data, subj_num) {
  
  subj_num <- unique(input_data$subj_idx) # 每个被试的编号
  n <- length(unique(input_data$subj_idx)) # 获取被试数量
  
  BFs_association <- rep(1, length(subj_num))
  BFs_difficulty <- rep(1, length(subj_num))
  BFs_int <- rep(1, length(subj_num))
  
  for (i in seq_along(subj_num)) {
    if (i == 1) {
      next
    }
    input_data$subj_idx <- as.character(input_data$subj_idx)
    id <- unique(input_data$subj_idx)[1:i]
    df.selected <- input_data %>% dplyr::filter(subj_idx %in% id)
    df.selected$subj_idx <- as.factor(df.selected$subj_idx)
    df.selected$difficulty <- as.factor(df.selected$difficulty)
    df.selected$association <- as.factor(df.selected$association)
    
    bayesfactors <- BayesFactor::generalTestBF(
      acc ~ association*difficulty*subj_idx - subj_idx:association:difficulty,
      data = data.frame(df.selected), 
      whichRandom = "subj_idx",
      neverExclude = "subj_idx", 
      whichModels = "all", progress = FALSE)
    
    null <- bayesfactors[8]
    full <- bayesfactors[7]  # 全模型
    BF_full.n <- full/null  # 全模型与null对比
    BF_excinx.n <- bayesfactors[4]/null
    BF_d.n <- bayesfactors[2]/null
    BF_a.n <- bayesfactors[1]/null
    BFs_association[i] <- BF_excinx.n/BF_d.n  # 计算association主效应的BF
    BFs_difficulty[i] <- BF_excinx.n/BF_a.n  # 计算difficulty的BF
    BFs_int[i] <- BF_full.n/BF_excinx.n  # 计算交互项的BF
  }
  
  aov_output <- tibble::tibble(BFs_int, BFs_association, BFs_difficulty)  # 整合为数据框
  
  dat_plot <- aov_output %>% 
    dplyr::mutate(n = 1:nrow(.)) %>% 
    tidyr::pivot_longer(BFs_int:BFs_difficulty, names_to = "Effect", 
                        values_to = "Bayes_Factor") %>% 
    dplyr::mutate(`logBF` = log(`Bayes_Factor`)) %>% 
    dplyr::mutate(dplyr::across(where(is.double), 
                                ~round(.x, digits = 2)))
  
  return(dat_plot)
}
```

```{r}
# 计算 rt 的 bf 值
analyze_rt_bf <- function(input_data, subj_num) {
  
  subj_num <- unique(input_data$subj_idx) # 每个被试的编号
  n <- length(unique(input_data$subj_idx)) # 获取被试数量
  
  BFs_association <- rep(1, length(subj_num))
  BFs_difficulty <- rep(1, length(subj_num))
  BFs_int <- rep(1, length(subj_num))
  
  for (i in seq_along(subj_num)) {
    if (i == 1) {
      next
    }
    input_data$subj_idx <- as.character(input_data$subj_idx)
    id <- unique(input_data$subj_idx)[1:i]
    df.selected <- input_data %>% dplyr::filter(subj_idx %in% id)
    df.selected$subj_idx <- as.factor(df.selected$subj_idx)
    df.selected$difficulty <- as.factor(df.selected$difficulty)
    df.selected$association <- as.factor(df.selected$association)
    
    bayesfactors <- BayesFactor::generalTestBF(
      rt ~ association*difficulty*subj_idx - subj_idx:association:difficulty,
      data = data.frame(df.selected), 
      whichRandom = "subj_idx",
      neverExclude = "subj_idx", 
      whichModels = "all", progress = FALSE)
    
    null <- bayesfactors[8]
    full <- bayesfactors[7]  # 全模型
    BF_full.n <- full/null  # 全模型与null对比
    BF_excinx.n <- bayesfactors[4]/null
    BF_d.n <- bayesfactors[2]/null
    BF_a.n <- bayesfactors[1]/null
    BFs_association[i] <- BF_excinx.n/BF_d.n  # 计算association主效应的BF
    BFs_difficulty[i] <- BF_excinx.n/BF_a.n  # 计算difficulty的BF
    BFs_int[i] <- BF_full.n/BF_excinx.n  # 计算交互项的BF
  }
  
  aov_output <- tibble::tibble(BFs_int, BFs_association, BFs_difficulty)  # 整合为数据框
  
  dat_plot <- aov_output %>% 
    dplyr::mutate(n = 1:nrow(.)) %>% 
    tidyr::pivot_longer(BFs_int:BFs_difficulty, names_to = "Effect", 
                        values_to = "Bayes_Factor") %>% 
    dplyr::mutate(`logBF` = log(`Bayes_Factor`)) %>% 
    dplyr::mutate(dplyr::across(where(is.double), 
                                ~round(.x, digits = 2)))
  
  return(dat_plot)
}
```

```{r}
# 绘图函数
plot_data <- function(dat_plot) {
  # 获取数据名
  data_name <- deparse(substitute(dat_plot))
  # 从数据名中区分不同的条件
  split_result <- strsplit(data_name, "_")[[1]]
  condition <- split_result[2:3]
  condition <- paste(condition, collapse = "_")
  
  plot_obj <- dat_plot %>% 
    dplyr::filter(Effect == "BFs_int") %>% 
    ggplot(aes(x = n, y = logBF)) + 
    geom_point(size = 3) + 
    geom_line() + 
    geom_hline(aes(yintercept = log(1)), linetype = "dashed") +
    geom_hline(aes(yintercept = log(10)), linetype = "dashed") +
    labs(y = TeX("$\\log(BF_{10}) $")) + 
     ggtitle(paste("交互作用的贝叶斯因子数值变化趋势", condition)) +  
    scale_y_continuous(
      breaks = c(0, round(log(10), 1), 
                 round(log(100), 1), 
                 round(log(1000), 1), 
                 round(log(10000), 1), 
                 round(log(100000), 1), 
                 round(log(1000000), 1),
                 round(log(10000000), 1), 
                 round(log(100000000), 1), 
                 round(log(100000000), 1), 
                 round(log(1000000000), 1), 
                 round(log(1000000000), 1), 
                 round(log(10000000000), 1)
    )
    ) + 
    theme(
      panel.background = element_blank(),
      plot.margin = unit(c(1, 1, 1, 1), "cm"),
      plot.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(size = 22, 
                                # family = "song",
                                face = "bold",
                                hjust = 0.5,
                                margin = margin(b = 15)),
      axis.line = element_line(color = "black", linewidth = .5),
      axis.title = element_text(size = 18, color = "black",
                                face = "bold"),
      axis.text = element_text(size = 15, color = "black"),
      axis.text.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.ticks = element_line(size = .5),
      panel.grid = element_blank(),
      legend.position.inside = c(0.20, 0.8),
      legend.background = element_rect(color = "black"),
      legend.text = element_text(size = 15),
      legend.margin = margin(t = 5, l = 5, r = 5, b = 5),
      legend.key = element_rect(color = NA, fill = NA)
    )
  
  return(plot_obj)
}
```

## 正确率分析（多因素重复测量方差分析）

### 运动组

```{r}
# 数据的基本信息
subj_num <- unique(df_acc_motion$subj_idx) # 每个被试的编号
n <- length(unique(df_acc_motion$subj_idx)) # 一共有多少个被试
n

# 计算 bf 值
bf_acc_motion <- analyze_acc_bf(df_acc_motion, subj_num)
bf_acc_motion

# 绘制图形
result_plot <- plot_data(bf_acc_motion)
result_plot
```

### 颜色组

```{r}
# 数据的基本信息
subj_num <- unique(df_acc_color$subj_idx) # 每个被试的编号
n <- length(unique(df_acc_color$subj_idx)) # 一共有多少个被试
n

# 计算 bf 值
bf_acc_color <- analyze_acc_bf(df_acc_color, subj_num)
bf_acc_color

# 绘制图形
result_plot <- plot_data(bf_acc_color)
result_plot
```

## 反应时分析（多因素重复测量方差分析）

### 运动组

```{r}
# 数据的基本信息
subj_num <- unique(df_rt_motion$subj_idx) # 每个被试的编号
n <- length(unique(df_rt_motion$subj_idx)) # 一共有多少个被试
n

# 计算 bf 值
bf_rt_motion <- analyze_rt_bf(df_rt_motion, subj_num)
bf_rt_motion

# 绘制图形
result_plot <- plot_data(bf_rt_motion)
result_plot
```

### 颜色组

```{r}
# 数据的基本信息
subj_num <- unique(df_rt_color$subj_idx) # 每个被试的编号
n <- length(unique(df_rt_color$subj_idx)) # 一共有多少个被试
n

# 计算 bf 值
bf_rt_color <- analyze_rt_bf(df_rt_color, subj_num)
bf_rt_color

# 绘制图形
result_plot <- plot_data(bf_rt_color)
result_plot
```

## dprime 分析（单因素重复测量方差分析）

```{r}
# 定义函数计算 dprime 的 bf 值
analyze_dprime_bf <- function(input_data, subj_num) {
  
  subj_num <- unique(input_data$subj_idx) # 每个被试的编号
  n <- length(unique(input_data$subj_idx)) # 获取被试数量
  
  BFs_difficulty <- rep(1, length(subj_num))
  
  for (i in seq_along(subj_num)) {
    if (i == 1) {
      next
    }
    input_data$subj_idx <- as.character(input_data$subj_idx)
    id <- unique(input_data$subj_idx)[1:i]
    df.selected <- input_data %>% dplyr::filter(subj_idx %in% id)
    df.selected$subj_idx <- as.factor(df.selected$subj_idx)
    df.selected$difficulty <- as.factor(df.selected$difficulty)
    
    bayesfactors <- BayesFactor::generalTestBF(
      dprime ~ difficulty*subj_idx - subj_idx:difficulty,
      data = data.frame(df.selected), 
      whichRandom = "subj_idx",
      neverExclude = "subj_idx", 
      whichModels = "all", progress = FALSE)
    
    null <- bayesfactors[2]
    full <- bayesfactors[1]  # 难度效应
    BFs_difficulty[i] <- full/null  # 难度效应与null对比
  }
  
  aov_output <- tibble::tibble(BFs_difficulty)
  
  dat_plot <- aov_output %>% 
    dplyr::mutate(n = 1:nrow(.)) %>% 
    tidyr::pivot_longer(BFs_difficulty, names_to = "Effect", 
                        values_to = "Bayes_Factor") %>% 
    dplyr::mutate(`logBF` = log(`Bayes_Factor`)) %>% 
    dplyr::mutate(dplyr::across(where(is.double), 
                                ~round(.x, digits = 2)))
  
  return(dat_plot)
}
```

```{r}
# 绘图函数
plot_dprime <- function(dat_plot) {
  # 获取数据名
  data_name <- deparse(substitute(dat_plot))
  # 从数据名中区分不同的条件
  split_result <- strsplit(data_name, "_")[[1]]
  condition <- split_result[2:3]
  condition <- paste(condition, collapse = "_")
  
  plot_obj <- dat_plot %>% 
    dplyr::filter(Effect == "BFs_difficulty") %>% 
    ggplot(aes(x = n, y = logBF)) + 
    geom_point(size = 3) + 
    geom_line() + 
    geom_hline(aes(yintercept = log(1)), linetype = "dashed") +
    geom_hline(aes(yintercept = log(10)), linetype = "dashed") +
    labs(y = TeX("$\\log(BF_{10}) $")) + 
     ggtitle(paste("BF 值变化趋势", condition)) +  
    scale_y_continuous(
      breaks = c(0, round(log(10), 1), 
                 round(log(100), 1), 
                 round(log(1000), 1), 
                 round(log(10000), 1), 
                 round(log(100000), 1), 
                 round(log(1000000), 1),
                 round(log(10000000), 1), 
                 round(log(100000000), 1), 
                 round(log(100000000), 1), 
                 round(log(1000000000), 1), 
                 round(log(1000000000), 1), 
                 round(log(10000000000), 1)
    )
    ) + 
    theme(
      panel.background = element_blank(),
      plot.margin = unit(c(1, 1, 1, 1), "cm"),
      plot.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(size = 22, 
                                # family = "song",
                                face = "bold",
                                hjust = 0.5,
                                margin = margin(b = 15)),
      axis.line = element_line(color = "black", linewidth = .5),
      axis.title = element_text(size = 18, color = "black",
                                face = "bold"),
      axis.text = element_text(size = 15, color = "black"),
      axis.text.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.ticks = element_line(size = .5),
      panel.grid = element_blank(),
      legend.position.inside = c(0.20, 0.8),
      legend.background = element_rect(color = "black"),
      legend.text = element_text(size = 15),
      legend.margin = margin(t = 5, l = 5, r = 5, b = 5),
      legend.key = element_rect(color = NA, fill = NA)
    )
  
  return(plot_obj)
}
```

### 运动组

```{r}
# 计算 bf 值
bf_dprime_motion <- analyze_dprime_bf(df_dPrime_motion, subj_num)
bf_dprime_motion

# 绘制图形
result_plot <- plot_dprime(bf_dprime_motion)
result_plot
```

### 颜色组

```{r}
# 计算 bf 值
bf_dprime_color <- analyze_dprime_bf(df_dPrime_color, subj_num)
bf_dprime_color

# 绘制图形
result_plot <- plot_dprime(bf_dprime_color)
result_plot
```
